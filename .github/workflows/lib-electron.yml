name: Electron automated build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        type: string

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Install missing software
        run: choco install nasm -yv

      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build library
        run: npm run dobuild 

      - name: Verify build output
        shell: pwsh
        run: |
          Write-Host "Checking for build directories..."
          $buildDirs = Get-ChildItem -Path "transports\http3-quiche" -Directory | Where-Object { $_.Name -like "build*" }
          foreach ($dir in $buildDirs) {
            Write-Host "Found: $($dir.FullName)"
            $size = (Get-ChildItem -Path $dir.FullName -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "  Size: $([math]::Round($size, 2)) MB"
            if (Test-Path "$($dir.FullName)\Release\webtransport.node") {
              $binSize = (Get-Item "$($dir.FullName)\Release\webtransport.node").Length / 1MB
              Write-Host "  Binary found: $([math]::Round($binSize, 2)) MB"
            }
          }

      - name: Create tarball
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $tarballName = "webtransport-electron-windows-x64-$version.tar.gz"
          
          # Create a staging directory with built artifacts
          New-Item -ItemType Directory -Force -Path "release" | Out-Null
          
          # Copy built transport package
          Copy-Item -Path "transports\http3-quiche\lib" -Destination "release\lib" -Recurse -Force
          if (Test-Path "transports\http3-quiche\dist") {
            Copy-Item -Path "transports\http3-quiche\dist" -Destination "release\dist" -Recurse -Force
          }
          Copy-Item -Path "transports\http3-quiche\package.json" -Destination "release\package.json" -Force
          if (Test-Path "transports\http3-quiche\README.md") {
            Copy-Item -Path "transports\http3-quiche\README.md" -Destination "release\README.md" -Force
          }
          Get-ChildItem -Path "transports\http3-quiche" -Filter "LICENSE*" | Copy-Item -Destination "release\" -Force
          
          # Copy built binaries - build outputs to build_{platform}_{arch}
          # On Windows x64, this is build_win32_x64
          $buildPath = "transports\http3-quiche\build_win32_x64"
          if (Test-Path $buildPath) {
            Copy-Item -Path $buildPath -Destination "release\build_win32_x64" -Recurse -Force
          } else {
            # Fallback: check for generic build directory
            $buildPath = "transports\http3-quiche\build"
            if (Test-Path $buildPath) {
              Copy-Item -Path $buildPath -Destination "release\build" -Recurse -Force
            } else {
              Write-Warning "No build directory found. Expected build_win32_x64 or build"
              # List what directories exist for debugging
              Get-ChildItem -Path "transports\http3-quiche" -Directory | Where-Object { $_.Name -like "build*" } | ForEach-Object { Write-Host "Found build directory: $($_.FullName)" }
            }
          }
          
          # Create tarball using tar
          tar -czf $tarballName -C release .
          
          # Report tarball size
          $tarballSize = (Get-Item $tarballName).Length / 1MB
          Write-Host "Created tarball: $tarballName"
          Write-Host "Tarball size: $([math]::Round($tarballSize, 2)) MB"
          
          # List contents for verification
          Write-Host "`nTarball contents:"
          tar -tzf $tarballName | Select-Object -First 20
          
          # Set output for next step
          echo "tarball_name=$tarballName" >> $env:GITHUB_OUTPUT

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v5
        with:
          name: release-tarball
          path: "*.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          files: "*.tar.gz"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
