name: Electron automated build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        type: string

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Install missing software
        run: choco install nasm -yv

      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up NodeJS
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build library
        run: npm run dobuild 

      - name: Verify build output
        shell: pwsh
        run: |
          Write-Host "Checking for build directories..."
          $buildDirs = Get-ChildItem -Path "transports\http3-quiche" -Directory | Where-Object { $_.Name -like "build*" }
          foreach ($dir in $buildDirs) {
            Write-Host "Found: $($dir.FullName)"
            $size = (Get-ChildItem -Path $dir.FullName -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "  Size: $([math]::Round($size, 2)) MB"
            if (Test-Path "$($dir.FullName)\Release\webtransport.node") {
              $binSize = (Get-Item "$($dir.FullName)\Release\webtransport.node").Length / 1MB
              Write-Host "  Binary found: $([math]::Round($binSize, 2)) MB"
            }
          }

      - name: Create tarball
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $tarballName = "webtransport-electron-windows-x64-$version.tar.gz"
          
          New-Item -ItemType Directory -Force -Path "release" | Out-Null
          
          Copy-Item -Path "transports\http3-quiche\lib" -Destination "release\lib" -Recurse -Force
          if (Test-Path "transports\http3-quiche\dist") {
            Copy-Item -Path "transports\http3-quiche\dist" -Destination "release\dist" -Recurse -Force
          }
          
          $packageJson = Get-Content "transports\http3-quiche\package.json" -Raw | ConvertFrom-Json
          
          if ($packageJson.scripts.PSObject.Properties['install']) {
            $packageJson.scripts.PSObject.Properties.Remove('install')
            Write-Host "Removed install script from package.json (pre-built package)"
          }
          
          $packageJson | ConvertTo-Json -Depth 10 | Set-Content "release\package.json" -Force
          
          if (Test-Path "transports\http3-quiche\README.md") {
            Copy-Item -Path "transports\http3-quiche\README.md" -Destination "release\README.md" -Force
          }
          Get-ChildItem -Path "transports\http3-quiche" -Filter "LICENSE*" | Copy-Item -Destination "release\" -Force
          
          $buildPath = "transports\http3-quiche\build_win32_x64"
          if (Test-Path $buildPath) {
            Copy-Item -Path $buildPath -Destination "release\build_win32_x64" -Recurse -Force
          } else {
            $buildPath = "transports\http3-quiche\build"
            if (Test-Path $buildPath) {
              Copy-Item -Path $buildPath -Destination "release\build" -Recurse -Force
            } else {
              Write-Warning "No build directory found. Expected build_win32_x64 or build"
              Get-ChildItem -Path "transports\http3-quiche" -Directory | Where-Object { $_.Name -like "build*" } | ForEach-Object { Write-Host "Found build directory: $($_.FullName)" }
            }
          }
          
          tar -czf $tarballName -C release .
          
          $tarballSize = (Get-Item $tarballName).Length / 1MB
          Write-Host "Created tarball: $tarballName"
          Write-Host "Tarball size: $([math]::Round($tarballSize, 2)) MB"
          
          Write-Host "`nTarball contents:"
          tar -tzf $tarballName | Select-Object -First 20
          
          echo "tarball_name=$tarballName" >> $env:GITHUB_OUTPUT

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v5
        with:
          name: release-tarball
          path: "*.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          files: "*.tar.gz"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
